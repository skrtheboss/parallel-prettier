const { readFileSync, existsSync } = require('fs');

function checkLockFiles() {
    const errors = [];
    if (existsSync('yarn.lock')) {
        errors.push('Invalid occurence of "yarn.lock" file. Please remove it and use only "package-lock.json"');
    }
    if (existsSync('pnpm-lock.yaml')) {
        errors.push('Invalid occurence of "pnpm-lock.yaml" file. Please remove it and use only "package-lock.json"');
    }
    try {
        const content = readFileSync('package-lock.json', 'utf-8');
        if (content.match(/localhost:487/)) {
            errors.push(
                'The "package-lock.json" has reference to local npm repository ("localhost:4873"). Please use "registry.npmjs.org" in "package-lock.json"'
            );
        }

        // eslint-disable-next-line global-require
        const packageJson = require('../../package-lock.json');

        if (packageJson.lockfileVersion !== 2) {
            errors.push(
                'The "package-lock.json" file was generated by an old npm version. Please use npm 7 or greater and run "npm install" again'
            );
        }
    } catch {
        errors.push('The "package-lock.json" does not exist or cannot be read');
    }
    return errors;
}

const invalid = checkLockFiles();

if (invalid.length > 0) {
    invalid.forEach((e) => console.log(e));
    process.exit(1);
} else {
    process.exit(0);
}
